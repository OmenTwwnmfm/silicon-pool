<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡…åŸº Key æ±  - è°ƒç”¨ç»Ÿè®¡</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/script.js"></script>
    <script src="/static/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .chart-wrapper {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .chart-wrapper:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .chart-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-align: center;
        }

        canvas {
            width: 100% !important;
            height: 300px !important;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            position: absolute;
            top: calc(50% - 25px);
            left: calc(50% - 25px);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .chart-container {
            position: relative;
            min-height: 300px;
        }

        .no-data-message {
            text-align: center;
            padding: 2rem;
            color: #64748b;
            font-style: italic;
        }
    </style>
</head>

<body>
    <nav id="navbar"></nav>
    <div class="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h1>ğŸ“Š è°ƒç”¨ç»Ÿè®¡åˆ†æ</h1>
            <button class="primary" onclick="refreshAllCharts()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>

        <div id="stats">
            ğŸ“Š ä»Šæ—¥è°ƒç”¨æ¬¡æ•°ï¼š<span id="todayCalls">0</span> æ¬¡
            | ä»Šæ—¥æ¶ˆè€— Tokenï¼š<span id="todayTokens">0</span> ä¸ª
            | æœ¬æœˆè°ƒç”¨æ¬¡æ•°ï¼š<span id="monthCalls">0</span> æ¬¡
            | æœ¬æœˆæ¶ˆè€— Tokenï¼š<span id="monthTokens">0</span> ä¸ª
        </div>

        <div class="charts-container">
            <div class="chart-wrapper">
                <h3 class="chart-title">ä»Šæ—¥è°ƒç”¨é¢‘ç‡</h3>
                <div class="chart-container">
                    <div id="hourlyCallsLoading" class="loading-spinner"></div>
                    <canvas id="hourlyCallsChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">ä»Šæ—¥ Token æ¶ˆè€—</h3>
                <div class="chart-container">
                    <div id="hourlyTokensLoading" class="loading-spinner"></div>
                    <canvas id="hourlyTokensChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">ä»Šæ—¥æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒ</h3>
                <div class="chart-container">
                    <div id="dailyModelsLoading" class="loading-spinner"></div>
                    <canvas id="dailyModelsChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">æœ¬æœˆæ¨¡å‹ä½¿ç”¨åˆ†å¸ƒ</h3>
                <div class="chart-container">
                    <div id="monthlyModelsLoading" class="loading-spinner"></div>
                    <canvas id="monthlyModelsChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">æœ¬æœˆè°ƒç”¨é¢‘ç‡</h3>
                <div class="chart-container">
                    <div id="dailyCallsLoading" class="loading-spinner"></div>
                    <canvas id="dailyCallsChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">æœ¬æœˆ Token æ¶ˆè€—</h3>
                <div class="chart-container">
                    <div id="dailyTokensLoading" class="loading-spinner"></div>
                    <canvas id="dailyTokensChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å›¾è¡¨å¯¹è±¡
        let hourlyCallsChart = null;
        let hourlyTokensChart = null;
        let dailyCallsChart = null;
        let dailyTokensChart = null;
        let dailyModelsChart = null;
        let monthlyModelsChart = null;

        // å›¾è¡¨é¢œè‰²
        const colors = {
            calls: 'rgba(68, 122, 238, 0.8)',
            inputTokens: 'rgba(100, 149, 237, 0.7)',
            outputTokens: 'rgba(25, 25, 112, 0.7)'
        };

        // æ¨¡å‹é¢œè‰²æ˜ å°„
        const modelColorMap = {};

        // ä¸ºç‰¹å®šæ¨¡å‹ç”Ÿæˆæˆ–è·å–é¢œè‰²
        function getModelColor(modelName) {
            // å¦‚æœæ¨¡å‹å·²æœ‰æŒ‡å®šé¢œè‰²ï¼Œåˆ™ä½¿ç”¨å·²æœ‰é¢œè‰²
            if (modelColorMap[modelName]) {
                return modelColorMap[modelName];
            }

            // ä¸ºæ–°æ¨¡å‹ç”Ÿæˆé¢œè‰²
            const hue = Math.random() * 360;
            const saturation = 60 + Math.random() * 20;
            const lightness = 80 + Math.random() * 10;
            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;

            // å­˜å‚¨é¢œè‰²æ˜ å°„
            modelColorMap[modelName] = color;
            return color;
        }

        // ä¸ºé¥¼å›¾è·å–æ¨¡å‹é¢œè‰²
        function getModelColors(modelLabels) {
            return modelLabels.map(label => getModelColor(label));
        }

        // åŠ è½½æ—¥å°æ—¶ç»Ÿè®¡æ•°æ®
        async function loadDailyStats() {
            document.getElementById('hourlyCallsLoading').style.display = 'block';
            document.getElementById('hourlyTokensLoading').style.display = 'block';
            document.getElementById('dailyModelsLoading').style.display = 'block';

            try {
                const response = await fetch('/api/stats/daily');
                const data = await response.json();

                // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
                const totalCalls = data.calls.reduce((a, b) => a + b, 0);
                const totalInputTokens = data.input_tokens.reduce((a, b) => a + b, 0);
                const totalOutputTokens = data.output_tokens.reduce((a, b) => a + b, 0);
                document.getElementById('todayCalls').textContent = totalCalls;
                document.getElementById('todayTokens').textContent = totalInputTokens + totalOutputTokens;

                // æ ¼å¼åŒ–å°æ—¶æ ‡ç­¾
                const hourLabels = data.labels.map(hour => `${hour}:00`);

                // ç»˜åˆ¶è°ƒç”¨é¢‘ç‡å›¾è¡¨
                renderHourlyCallsChart(hourLabels, data.calls);

                // ç»˜åˆ¶Tokenæ¶ˆè€—å›¾è¡¨
                renderHourlyTokensChart(hourLabels, data.input_tokens, data.output_tokens);

                // ç»˜åˆ¶ä»Šæ—¥æ¨¡å‹ä½¿ç”¨é¥¼å›¾
                renderDailyModelsChart(data.model_labels, data.model_tokens);
            } catch (error) {
                console.error('Failed to load daily stats:', error);
                showNoDataMessage('hourlyCallsChart');
                showNoDataMessage('hourlyTokensChart');
                showNoDataMessage('dailyModelsChart');
            } finally {
                document.getElementById('hourlyCallsLoading').style.display = 'none';
                document.getElementById('hourlyTokensLoading').style.display = 'none';
                document.getElementById('dailyModelsLoading').style.display = 'none';
            }
        }

        // åŠ è½½æœˆåº¦ç»Ÿè®¡æ•°æ®
        async function loadMonthlyStats() {
            document.getElementById('dailyCallsLoading').style.display = 'block';
            document.getElementById('dailyTokensLoading').style.display = 'block';
            document.getElementById('monthlyModelsLoading').style.display = 'block';

            try {
                const response = await fetch('/api/stats/monthly');
                const data = await response.json();

                // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
                const totalCalls = data.calls.reduce((a, b) => a + b, 0);
                const totalInputTokens = data.input_tokens.reduce((a, b) => a + b, 0);
                const totalOutputTokens = data.output_tokens.reduce((a, b) => a + b, 0);
                document.getElementById('monthCalls').textContent = totalCalls;
                document.getElementById('monthTokens').textContent = totalInputTokens + totalOutputTokens;

                // æ ¼å¼åŒ–æ—¥æœŸæ ‡ç­¾
                const dayLabels = data.labels.map(day => `${day}æ—¥`);

                // ç»˜åˆ¶è°ƒç”¨é¢‘ç‡å›¾è¡¨
                renderDailyCallsChart(dayLabels, data.calls);

                // ç»˜åˆ¶Tokenæ¶ˆè€—å›¾è¡¨
                renderDailyTokensChart(dayLabels, data.input_tokens, data.output_tokens);

                // ç»˜åˆ¶æœ¬æœˆæ¨¡å‹ä½¿ç”¨é¥¼å›¾
                renderMonthlyModelsChart(data.model_labels, data.model_tokens);
            } catch (error) {
                console.error('Failed to load monthly stats:', error);
                showNoDataMessage('dailyCallsChart');
                showNoDataMessage('dailyTokensChart');
                showNoDataMessage('monthlyModelsChart');
            } finally {
                document.getElementById('dailyCallsLoading').style.display = 'none';
                document.getElementById('dailyTokensLoading').style.display = 'none';
                document.getElementById('monthlyModelsLoading').style.display = 'none';
            }
        }

        // ç»˜åˆ¶ä»Šæ—¥æ¨¡å‹ä½¿ç”¨é¥¼å›¾
        function renderDailyModelsChart(labels, data) {
            const ctx = document.getElementById('dailyModelsChart').getContext('2d');

            if (dailyModelsChart) {
                dailyModelsChart.destroy();
            }

            if (!labels || labels.length === 0 || data.every(value => value === 0)) {
                showNoDataMessage('dailyModelsChart');
                return;
            }

            const pieColors = getModelColors(labels);

            dailyModelsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: pieColors,
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} tokens (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç»˜åˆ¶æœ¬æœˆæ¨¡å‹ä½¿ç”¨é¥¼å›¾
        function renderMonthlyModelsChart(labels, data) {
            const ctx = document.getElementById('monthlyModelsChart').getContext('2d');

            if (monthlyModelsChart) {
                monthlyModelsChart.destroy();
            }

            if (!labels || labels.length === 0 || data.every(value => value === 0)) {
                showNoDataMessage('monthlyModelsChart');
                return;
            }

            const pieColors = getModelColors(labels);

            monthlyModelsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: pieColors,
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} tokens (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç»˜åˆ¶å°æ—¶è°ƒç”¨é¢‘ç‡å›¾è¡¨
        function renderHourlyCallsChart(labels, data) {
            const ctx = document.getElementById('hourlyCallsChart').getContext('2d');

            if (hourlyCallsChart) {
                hourlyCallsChart.destroy();
            }

            if (data.every(value => value === 0)) {
                showNoDataMessage('hourlyCallsChart');
                return;
            }

            hourlyCallsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è°ƒç”¨æ¬¡æ•°',
                        data: data,
                        backgroundColor: colors.calls,
                        borderColor: colors.calls,
                        borderWidth: 2,
                        pointBackgroundColor: 'white',
                        pointBorderColor: colors.calls,
                        pointBorderWidth: 2,
                        tension: 0.5,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ç»˜åˆ¶å°æ—¶Tokenæ¶ˆè€—å›¾è¡¨
        function renderHourlyTokensChart(labels, inputData, outputData) {
            const ctx = document.getElementById('hourlyTokensChart').getContext('2d');

            if (hourlyTokensChart) {
                hourlyTokensChart.destroy();
            }

            if (inputData.every(value => value === 0) && outputData.every(value => value === 0)) {
                showNoDataMessage('hourlyTokensChart');
                return;
            }

            hourlyTokensChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'è¾“å…¥ Tokens',
                            data: inputData,
                            backgroundColor: colors.inputTokens,
                            borderColor: colors.inputTokens,
                            borderWidth: 1
                        },
                        {
                            label: 'è¾“å‡º Tokens',
                            data: outputData,
                            backgroundColor: colors.outputTokens,
                            borderColor: colors.outputTokens,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ç»˜åˆ¶æ—¥è°ƒç”¨é¢‘ç‡å›¾è¡¨
        function renderDailyCallsChart(labels, data) {
            const ctx = document.getElementById('dailyCallsChart').getContext('2d');

            if (dailyCallsChart) {
                dailyCallsChart.destroy();
            }

            if (data.every(value => value === 0)) {
                showNoDataMessage('dailyCallsChart');
                return;
            }

            dailyCallsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è°ƒç”¨æ¬¡æ•°',
                        data: data,
                        backgroundColor: colors.calls,
                        borderColor: colors.calls,
                        borderWidth: 2,
                        pointBackgroundColor: 'white',
                        pointBorderColor: colors.calls,
                        pointBorderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ç»˜åˆ¶æ—¥Tokenæ¶ˆè€—å›¾è¡¨
        function renderDailyTokensChart(labels, inputData, outputData) {
            const ctx = document.getElementById('dailyTokensChart').getContext('2d');

            if (dailyTokensChart) {
                dailyTokensChart.destroy();
            }

            if (inputData.every(value => value === 0) && outputData.every(value => value === 0)) {
                showNoDataMessage('dailyTokensChart');
                return;
            }

            dailyTokensChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'è¾“å…¥ Tokens',
                            data: inputData,
                            backgroundColor: colors.inputTokens,
                            borderColor: colors.inputTokens,
                            borderWidth: 1
                        },
                        {
                            label: 'è¾“å‡º Tokens',
                            data: outputData,
                            backgroundColor: colors.outputTokens,
                            borderColor: colors.outputTokens,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // æ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯
        function showNoDataMessage(canvasId) {
            const canvas = document.getElementById(canvasId);
            const parent = canvas.parentElement;

            const existingMessage = parent.querySelector('.no-data-message');
            if (!existingMessage) {
                const message = document.createElement('div');
                message.className = 'no-data-message';
                message.textContent = 'æš‚æ— æ•°æ®';
                parent.appendChild(message);
            }
        }

        // åˆ·æ–°æ‰€æœ‰å›¾è¡¨
        function refreshAllCharts() {
            loadDailyStats();
            loadMonthlyStats();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å›¾è¡¨
        document.addEventListener('DOMContentLoaded', function () {
            loadDailyStats();
            loadMonthlyStats();
        });
    </script>
</body>

</html>