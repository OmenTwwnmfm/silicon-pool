<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡…åŸº Key æ±  - è°ƒç”¨æ—¥å¿—</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/script.js"></script>
    <script src="/static/navbar.js"></script>
    <style>
        .operation-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 500;
            color: #334155;
        }

        .filter-select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background-color: white;
            min-width: 150px;
        }

        .button-group {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .operation-container {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .filter-item {
                justify-content: space-between;
            }

            .button-group {
                margin: 0.5rem 0 0 0;
                width: 100%;
                display: flex;
                gap: 0.5rem;
            }

            .button-group button {
                flex: 1;
            }
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav id="navbar"></nav>

    <div class="container">
        <h1>API è°ƒç”¨æ—¥å¿—</h1>

        <div id="message"></div>

        <div class="operation-container">
            <div class="filter-item">
                <span class="filter-label">æ—¥æœŸè¿‡æ»¤:</span>
                <select id="dateFilter" class="filter-select" onchange="applyFilters()">
                    <option value="all">æ‰€æœ‰æ—¥æœŸ</option>
                    <option value="today">ä»…ä»Šå¤©</option>
                </select>
            </div>
            <div class="filter-item">
                <span class="filter-label">æ¨¡å‹è¿‡æ»¤:</span>
                <select id="modelFilter" class="filter-select" onchange="applyFilters()">
                    <option value="all">æ‰€æœ‰æ¨¡å‹</option>
                    <!-- æ¨¡å‹é€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                </select>
            </div>
            <div class="filter-item">
                <span class="filter-label">æ¥å£è¿‡æ»¤:</span>
                <select id="endpointFilter" class="filter-select" onchange="applyFilters()">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="chat_completions">å¯¹è¯</option>
                    <option value="completions">è¡¥å…¨</option>
                    <option value="embeddings">åµŒå…¥</option>
                    <option value="images_generations">ç”Ÿå›¾</option>
                    <option value="rerank">é‡æ’åº</option>
                </select>
            </div>
            <div class="button-group">
                <button class="primary" onclick="fetchLogs()">ğŸ”„ åˆ·æ–°æ—¥å¿—</button>
                <button class="danger" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>

        <table id="logsTable">
            <thead>
                <tr>
                    <th>ä½¿ç”¨çš„ Key</th>
                    <th>æ¨¡å‹</th>
                    <th>æ¥å£</th>
                    <th>è°ƒç”¨æ—¶é—´</th>
                    <th>è¾“å…¥ Token</th>
                    <th>è¾“å‡º Token</th>
                    <th>æ€» Token</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let currentFilters = {
            page: 1,
            dateFilter: 'all',
            model: 'all',
            endpoint: 'all'
        };

        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadModelOptions() {
            try {
                const response = await fetch('/logs?page=1');
                const data = await response.json();

                if (data.available_models && data.available_models.length > 0) {
                    const modelSelect = document.getElementById('modelFilter');
                    // ä¿ç•™"æ‰€æœ‰æ¨¡å‹"é€‰é¡¹
                    const allOption = modelSelect.options[0];
                    modelSelect.innerHTML = '';
                    modelSelect.appendChild(allOption);

                    // æ·»åŠ æ‰€æœ‰å¯ç”¨æ¨¡å‹
                    data.available_models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åº”ç”¨è¿‡æ»¤æ¡ä»¶
        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter').value;
            const model = document.getElementById('modelFilter').value;
            const endpoint = document.getElementById('endpointFilter').value;

            currentFilters = {
                page: 1, // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                dateFilter: dateFilter,
                model: model,
                endpoint: endpoint
            };

            fetchLogs();
        }

        // Logs fetching and pagination with filters
        async function fetchLogs(page = 1) {
            // æ›´æ–°å½“å‰é¡µç 
            currentFilters.page = page;

            document.querySelector("#logsTable tbody").innerHTML = `
                <tr>
                    <td colspan="7" style="padding: 2rem; color: #64748b;">
                        â³ æ­£åœ¨åŠ è½½æ—¥å¿—...
                    </td>
                </tr>
            `;

            const url = `/logs?page=${currentFilters.page}&date_filter=${currentFilters.dateFilter}&model=${currentFilters.model}&endpoint=${currentFilters.endpoint}`;
            const response = await fetch(url);
            const data = await response.json();
            const tbody = document.querySelector("#logsTable tbody");
            tbody.innerHTML = "";

            if (data.logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 2rem; color: #64748b; text-align: center;">
                            æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®°å½•
                        </td>
                    </tr>
                `;
                document.getElementById("pagination").innerHTML = "";
                return;
            }

            data.logs.forEach(log => {
                const tr = document.createElement("tr");
                const dt = new Date(log.call_time * 1000);

                // æ ¼å¼åŒ–æ¥å£æ˜¾ç¤º
                let displayEndpoint = log.endpoint || "æœªçŸ¥";
                if (displayEndpoint === "chat_completions") displayEndpoint = "å¯¹è¯";
                else if (displayEndpoint === "completions") displayEndpoint = "è¡¥å…¨";
                else if (displayEndpoint === "embeddings") displayEndpoint = "åµŒå…¥";
                else if (displayEndpoint === "images_generations") displayEndpoint = "ç”Ÿå›¾";
                else if (displayEndpoint === "rerank") displayEndpoint = "é‡æ’åº";

                tr.innerHTML = `
                    <td class="key-cell" title="${log.used_key}">${maskKey(log.used_key)}</td>
                    <td>${log.model}</td>
                    <td>${displayEndpoint}</td>
                    <td>${dt.toLocaleString()}</td>
                    <td>${log.input_tokens}</td>
                    <td>${log.output_tokens}</td>
                    <td>${log.total_tokens}</td>
                `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°æ”¹è¿›åçš„åˆ†é¡µç³»ç»Ÿ
            renderPagination(data.page, Math.ceil(data.total / data.page_size), (newPage) => fetchLogs(newPage));
        }

        async function clearLogs() {
            if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) return;
            const response = await fetch("/clear_logs", { method: "POST" });
            const data = await response.json();
            showMessage(data.message, "success");
            fetchLogs();
            // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
            loadModelOptions();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // åŠ è½½æ¨¡å‹åˆ—è¡¨
            loadModelOptions();
            // åŠ è½½æ—¥å¿—
            fetchLogs();
        });
    </script>
</body>

</html>